<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?define ProductVersion="1.0.0.0" ?>
  <?define ProductName="BlockPlane for Revit" ?>
  <?define Manufacturer="BlockPlane" ?>
  <?define UpgradeCode="C1D2E3F4-A5B6-7C8D-9E0F-1A2B3C4D5E6F" ?>
  
  <Product Id="*" 
           Name="$(var.ProductName)" 
           Language="1033" 
           Version="$(var.ProductVersion)" 
           Manufacturer="$(var.Manufacturer)" 
           UpgradeCode="$(var.UpgradeCode)">
    
    <Package InstallerVersion="500" 
             Compressed="yes" 
             InstallScope="perMachine" 
             Description="$(var.ProductName) Installer"
             Comments="Sustainable materials database and carbon footprint analysis for Revit"
             Manufacturer="$(var.Manufacturer)" />

    <!-- Upgrade logic -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    
    <!-- Media -->
    <MediaTemplate EmbedCab="yes" />

    <!-- Feature: Main application -->
    <Feature Id="ProductFeature" 
             Title="BlockPlane for Revit" 
             Level="1" 
             Description="Core plugin files and dependencies"
             ConfigurableDirectory="INSTALLFOLDER">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="DependencyComponents" />
      <ComponentGroupRef Id="AddinManifest" />
    </Feature>

    <!-- UI -->
    <UIRef Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    
    <!-- License agreement -->
    <WixVariable Id="WixUILicenseRtf" Value="Resources\License.rtf" />
    
    <!-- Icons -->
    <Icon Id="BlockPlaneIcon.ico" SourceFile="Resources\BlockPlane.ico" />
    <Property Id="ARPPRODUCTICON" Value="BlockPlaneIcon.ico" />
    
    <!-- Add/Remove Programs properties -->
    <Property Id="ARPHELPLINK" Value="https://blockplane.com/support" />
    <Property Id="ARPURLINFOABOUT" Value="https://blockplane.com" />
    <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />
    
    <!-- Installation directory -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- Program Files -->
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="ManufacturerFolder" Name="BlockPlane">
          <Directory Id="INSTALLFOLDER" Name="Revit Plugin" />
        </Directory>
      </Directory>
      
      <!-- AppData for add-in manifest -->
      <Directory Id="CommonAppDataFolder">
        <Directory Id="AutodeskFolder" Name="Autodesk">
          <Directory Id="RevitFolder" Name="Revit">
            <Directory Id="AddinsFolder2024" Name="Addins">
              <Directory Id="Addins2024" Name="2024" />
            </Directory>
            <Directory Id="AddinsFolder2025" Name="Addins">
              <Directory Id="Addins2025" Name="2025" />
            </Directory>
          </Directory>
        </Directory>
      </Directory>
      
      <!-- Start Menu -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="BlockPlane for Revit" />
      </Directory>
    </Directory>

    <!-- Components: Main plugin files -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="MainDLL" Guid="A1B2C3D4-E5F6-7890-ABCD-111111111111">
        <File Id="BlockPlaneRevitPlugin.dll" 
              Source="..\RevitPlugin\bin\Release\BlockPlane.RevitPlugin.dll" 
              KeyPath="yes" />
      </Component>
      
      <Component Id="ConfigFile" Guid="A1B2C3D4-E5F6-7890-ABCD-222222222222">
        <File Id="AppConfig" 
              Source="..\RevitPlugin\bin\Release\BlockPlane.RevitPlugin.dll.config" 
              KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Components: Dependencies -->
    <ComponentGroup Id="DependencyComponents" Directory="INSTALLFOLDER">
      <Component Id="RestSharp" Guid="A1B2C3D4-E5F6-7890-ABCD-333333333333">
        <File Id="RestSharp.dll" 
              Source="..\RevitPlugin\bin\Release\RestSharp.dll" 
              KeyPath="yes" />
      </Component>
      
      <Component Id="NewtonsoftJson" Guid="A1B2C3D4-E5F6-7890-ABCD-444444444444">
        <File Id="Newtonsoft.Json.dll" 
              Source="..\RevitPlugin\bin\Release\Newtonsoft.Json.dll" 
              KeyPath="yes" />
      </Component>
      
      <Component Id="SQLite" Guid="A1B2C3D4-E5F6-7890-ABCD-555555555555">
        <File Id="System.Data.SQLite.dll" 
              Source="..\RevitPlugin\bin\Release\System.Data.SQLite.dll" 
              KeyPath="yes" />
      </Component>
      
      <Component Id="Serilog" Guid="A1B2C3D4-E5F6-7890-ABCD-666666666666">
        <File Id="Serilog.dll" 
              Source="..\RevitPlugin\bin\Release\Serilog.dll" 
              KeyPath="yes" />
      </Component>
      
      <Component Id="SerilogSinksFile" Guid="A1B2C3D4-E5F6-7890-ABCD-777777777777">
        <File Id="Serilog.Sinks.File.dll" 
              Source="..\RevitPlugin\bin\Release\Serilog.Sinks.File.dll" 
              KeyPath="yes" />
      </Component>
      
      <Component Id="iTextSharp" Guid="A1B2C3D4-E5F6-7890-ABCD-888888888888">
        <File Id="itextsharp.dll" 
              Source="..\RevitPlugin\bin\Release\itextsharp.dll" 
              KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Components: Add-in manifest for Revit 2024 -->
    <ComponentGroup Id="AddinManifest">
      <Component Id="AddinManifest2024" Directory="Addins2024" Guid="A1B2C3D4-E5F6-7890-ABCD-999999999999">
        <File Id="BlockPlane2024.addin" 
              Source="Templates\BlockPlane.addin" 
              KeyPath="yes" />
        <Environment Id="BLOCKPLANE_INSTALL_PATH_2024" 
                     Name="BLOCKPLANE_INSTALL_PATH" 
                     Value="[INSTALLFOLDER]" 
                     Permanent="no" 
                     Part="last" 
                     Action="set" 
                     System="yes" />
      </Component>
      
      <Component Id="AddinManifest2025" Directory="Addins2025" Guid="A1B2C3D4-E5F6-7890-ABCD-AAAAAAAAAAAA">
        <File Id="BlockPlane2025.addin" 
              Source="Templates\BlockPlane.addin" 
              KeyPath="yes" />
        <Environment Id="BLOCKPLANE_INSTALL_PATH_2025" 
                     Name="BLOCKPLANE_INSTALL_PATH" 
                     Value="[INSTALLFOLDER]" 
                     Permanent="no" 
                     Part="last" 
                     Action="set" 
                     System="yes" />
      </Component>
    </ComponentGroup>

    <!-- Start Menu shortcuts -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="A1B2C3D4-E5F6-7890-ABCD-BBBBBBBBBBBB">
        <Shortcut Id="UninstallProduct"
                  Name="Uninstall BlockPlane for Revit"
                  Description="Uninstalls BlockPlane for Revit"
                  Target="[SystemFolder]msiexec.exe"
                  Arguments="/x [ProductCode]" />
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" 
                       Key="Software\BlockPlane\Revit Plugin" 
                       Name="installed" 
                       Type="integer" 
                       Value="1" 
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Registry entries -->
    <Component Id="RegistryEntries" Directory="INSTALLFOLDER" Guid="A1B2C3D4-E5F6-7890-ABCD-CCCCCCCCCCCC">
      <RegistryKey Root="HKLM" Key="Software\BlockPlane\Revit Plugin">
        <RegistryValue Type="string" Name="InstallPath" Value="[INSTALLFOLDER]" KeyPath="yes" />
        <RegistryValue Type="string" Name="Version" Value="$(var.ProductVersion)" />
        <RegistryValue Type="string" Name="InstallDate" Value="[Date]" />
      </RegistryKey>
    </Component>

  </Product>
</Wix>
